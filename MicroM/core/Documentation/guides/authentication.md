# Guide: Configuring Authentication & Authorization

The MicroM Framework includes a comprehensive, built-in system for handling security. By default, all API endpoints generated by the framework require authentication. Authorization is managed by assigning users to groups, and groups to specific menu items which grant access to API routes.

This guide explains how to configure this system.

## 1. Authentication Flow

MicroM uses a standard JSON Web Token (JWT) based authentication flow.
1.  A user logs in with their credentials.
2.  The server validates the credentials against the internal `MicromUsers` entity.
3.  Upon success, the server returns a short-lived **Access Token** (JWT) and a long-lived **Refresh Token** (stored in a secure, HttpOnly cookie).
4.  The client includes the Access Token in the `Authorization` header for all subsequent API requests.
5.  When the Access Token expires, the client uses the Refresh Token to request a new pair of tokens without requiring the user to log in again.

## 2. Authorization Concepts

Authorization is based on three main concepts: **Menus**, **Menu Items**, and **User Groups**. These are defined in your application project using base classes from the `MicroM.DataDictionary.Configuration` namespace.

*   **API Routes**: The smallest unit of security. A route corresponds to a specific API endpoint (e.g., `api/Persons/get`).
*   **Menu Item (`MenuItemDefinition`)**: A logical container for a set of API routes required for a specific UI feature.
*   **Menu (`MenuDefinition`)**: A collection of related Menu Items that typically represents a whole section of your application.
*   **User Group (`UsersGroupDefinition`)**: Represents a role (e.g., "Administrators"). You grant permissions to a group by giving it access to one or more Menu Items.

For more details on these classes, see the [MicroM.DataDictionary Namespace documentation](../namespaces/DataDictionary/index.md).

## 3. Defining Permissions

Permissions are defined in code by creating classes in your application project that inherit from `MenuDefinition` and `UsersGroupDefinition`.

### Step 1: Define a Menu

First, create a `MenuDefinition` class that defines the menu structure and associates menu items with the API routes they need.

```csharp
// In YourProject/Init/HomeMenu.cs
using MicroM.DataDictionary.Configuration;
using MicroM.Extensions;
using YourProject.Entities;

public class HomeMenu : MenuDefinition
{
    public HomeMenu() : base("Home Menu") { }

    public MenuItemDefinition persons_management = new("Manage Persons",
        allowed_routes: [
            ..typeof(Persons).GetRoutePaths(
                AllowedRouteFlags.Views | AllowedRouteFlags.Edit,
                views: [nameof(PersonsDef.pers_brwStandard)]
            )
        ]);
}
```

### Step 2: Define a User Group

Next, create a `UsersGroupDefinition` class and assign the menu items to it.

```csharp
// In YourProject/Init/AdminGroup.cs
using MicroM.DataDictionary.Configuration;

public class AdminGroup : UsersGroupDefinition
{
    public AdminGroup() : base("Administrator Group")
    {
        var menu = new HomeMenu();
        AddMenuAllItems(menu);
    }
}
```

When the application starts, the framework reads these definitions and uses them to build the security rules.

## 4. Allowing Public Access

To allow anonymous access to specific endpoints, create a class in your project that implements the `MicroM.Configuration.IPublicEndpoints` interface.

```csharp
// In YourProject/Init/PublicEndpoints.cs
using MicroM.Configuration;
using MicroM.Extensions;
using YourProject.Entities;

public class PublicEndpoints : IPublicEndpoints
{
    public List<string>? AddAllowedPublicEndpointRoutes()
    {
        return [
            ..typeof(Persons).GetRoutePaths(
                AllowedRouteFlags.Views,
                views: [nameof(PersonsDef.pers_brwStandard)]
            ),
        ];
    }
}
```
